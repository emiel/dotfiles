vim9script

#set verbose=9

##
## Plugins
##

plug#begin('~/.vim/plugged')
Plug 'LnL7/vim-nix'
Plug 'NLKNguyen/papercolor-theme'
Plug 'chrisbra/matchit'
Plug 'dense-analysis/ale'
Plug 'junegunn/fzf'
Plug 'junegunn/fzf.vim'
Plug 'leafgarland/typescript-vim'
Plug 'maxmellon/vim-jsx-pretty'
Plug 'preservim/nerdtree'
Plug 'purescript-contrib/purescript-vim'
Plug 'rhysd/committia.vim'
Plug 'rizzatti/dash.vim'
Plug 'shumphrey/fugitive-gitlab.vim'
Plug 'tpope/vim-commentary'
Plug 'tpope/vim-fugitive'
Plug 'tpope/vim-git'
Plug 'tpope/vim-markdown'
Plug 'tpope/vim-rhubarb'
Plug 'tpope/vim-surround'
plug#end()

filetype plugin indent on

##
## Global Options
##

set autoindent
set autoread
set backspace=indent,eol,start
set breakindent
set clipboard^=unnamed,unnamedplus
set completeopt=menuone,longest,popup,noinsert,noselect
set confirm
set copyindent
set cursorline
set encoding=utf-8
set formatoptions+=j
set hidden
set history=1024
set hlsearch
set ignorecase
set incsearch
set laststatus=2
set lazyredraw
set list
set listchars=tab:>·,trail:·,nbsp:~
set modelines=0
set mouse=a
set mousemodel=popup_setpos
set nobackup
set nojoinspaces
set path-=/usr/include
set preserveindent
set ruler
set scrolloff=3
set shell=zsh
set shortmess=atc
set showbreak=+++
set showcmd
set showmatch
set smartcase
set smarttab
set spelllang=en_us
set statusline=%<%f\ %h%m%r%{FugitiveStatusline()}%=%-14.(%l,%c%V%)\ %P
set tags=tags;~
set termguicolors
set title
set ttyfast
set updatetime=1000
set visualbell
set wildignore+=*.o,*.pyc
set wildmenu
set wildmode=longest:full
set wildoptions=pum

# Prefer rg (ripgrep) over grep
if executable('rg')
  set grepprg=rg\ --vimgrep\ --no-heading\ --smart-case
  set grepformat=%f:%l:%c:%m
endif

##
## Mappings
##

g:mapleader = ','
g:localmapleader = '\'

# Remap , (Reverse last character-search command) to \ (default leader)
noremap \ ,

# Scroll the viewport faster
nnoremap <C-E> 4<C-E>
nnoremap <C-Y> 4<C-Y>
vnoremap <C-E> 4<C-E>
vnoremap <C-Y> 4<C-Y>

# Stop highlighting in addition to clearing and redrawing the screen.
nnoremap <C-L> :<C-U>nohlsearch<CR><C-L>

##
## Mappings
##

nnoremap <unique> <Leader>stw :<C-U>call StripTrailingWhitespace()<CR>

# ALE
nnoremap <unique> <Leader>ad <Plug>(ale_detail)
nnoremap <unique> <Leader>af <Plug>(ale_fix)
nnoremap <unique> <C-j> <Plug>(ale_next_wrap)
nnoremap <unique> <C-k> <Plug>(ale_previous_wrap)
imap <C-Space> <Plug>(ale_complete)

# Dash
nmap <unique> <silent> <leader>D <Plug>DashSearch

# fzf.vim
nnoremap <unique> <Leader>g :FzfRg<SPACE>
nnoremap <unique> <Leader>b :FzfBuffers<CR>
nnoremap <unique> <Leader>f :FzfFiles<CR>
nnoremap <unique> <Leader>h :FzfHelptags<CR>
nnoremap <unique> <silent>K :execute 'FzfRg' expand('<cword>')<CR>

# NERDTree
nnoremap <unique> <silent> <Leader>d :execute 'NERDTreeToggle' getcwd()<CR>
nnoremap <unique> <silent> <Leader>t :NERDTreeFind<CR>

# Spell checking
nnoremap <unique> <Leader>s :set spell!<CR>

# Toggle pasting
nnoremap <unique> <Leader>p :set paste!<CR>:set paste?<CR>

##
## Automatic commands
##

augroup vimrc
    # Remove all vimrc autocommands
    autocmd!

    # Jump to last position in file after opening. Nice!
    autocmd BufReadPost * {
        if line("'\"") > 0 && line("'\"") <= line('$')
            exe "normal! g`\""
        endif
    }
augroup END

##
## Colors
##

g:PaperColor_Theme_Options = {
  'theme': {
    'default': {
      'transparent_background': 1
    }
  }
}

syntax on

colorscheme PaperColor

##
## Commands
##

# ctags
#command! MakeTags !ctags -R .

##
## Plugin Configuration
##

#
# fzf.vim
#
g:fzf_command_prefix = 'Fzf'

if executable('rg')
  $FZF_DEFAULT_COMMAND = "rg --files  --hidden --glob '!{node_modules,.git}'"
endif

def FzfRgSuper(query: string, fullscreen: bool)
  const command_fmt = 'rg --column --line-number --no-heading --color=always --smart-case -- %s || true'
  const initial_command = printf(command_fmt, shellescape(query))
  const reload_command = printf(command_fmt, '{q}')
  const spec = {'options': ['--phony', '--query', query, '--bind', 'change:reload:' .. reload_command]}

  fzf#vim#grep(initial_command, 1, fzf#vim#with_preview(spec), fullscreen)
enddef

command! -nargs=* -bang FzfRG call FzfRgSuper(<q-args>, <bang>0)

#
# NERDTree
#

g:NERDTreeIgnore = ['^__pycache__$', '\~$']

#
# ALE
#

g:ale_completion_enabled = 1
g:ale_echo_msg_format = '[%linter%] %code: %%s'
g:ale_fix_on_save = 1
g:ale_lint_on_save = 0
g:ale_lsp_suggestions = 1
g:ale_python_reorder_python_imports_options = '--py39-plus'
g:ale_sign_error = 'E>'
g:ale_sign_info = 'I>'
g:ale_sign_warning = 'W>'
g:ale_virtualtext_cursor = 'current'

# Use relative pathnames in find references; can also pipe paths to FZF
nnoremap <silent> <Plug>(ale_find_references_relative) :ALEFindReferences -relative<Return>

def OnALELSPStarted()
    setlocal omnifunc=ale#completion#OmniFunc
    setlocal signcolumn=number

    nmap <buffer> gd <Plug>(ale_go_to_definition)
    nmap <buffer> gh <Plug>(ale_hover)
    nmap <buffer> gi <Plug>(ale_go_to_implementation)
    nmap <buffer> gI <Plug>(ale_import)
    nmap <buffer> gn <Plug>(ale_rename)
    nmap <buffer> gp <Plug>(ale_peek_definition)
    nmap <buffer> gr <Plug>(ale_find_references_relative)
    nmap <buffer> gt <Plug>(ale_go_to_type_definition)
enddef

augroup ale_lsp
    autocmd!
    autocmd User ALELSPStarted OnALELSPStarted()
augroup END
