vim9script

##
## Plugins
##

plug#begin('~/.vim/plugged')
Plug 'cespare/vim-toml'
Plug 'chrisbra/matchit'
Plug 'dense-analysis/ale'
Plug 'dense-analysis/neural'
Plug 'EdenEast/nightfox.nvim'
Plug 'hashivim/vim-terraform'
Plug 'isobit/vim-caddyfile'
Plug 'junegunn/fzf'
Plug 'junegunn/fzf.vim'
Plug 'junegunn/goyo.vim'
Plug 'kaarmu/typst.vim'
Plug 'leafgarland/typescript-vim'
Plug 'NLKNguyen/papercolor-theme'
Plug 'PhilT/vim-fsharp'
Plug 'preservim/nerdtree'
Plug 'purescript-contrib/purescript-vim'
Plug 'rhysd/committia.vim'
Plug 'rizzatti/dash.vim'
Plug 'shinglyu/vim-codespell'
Plug 'tpope/vim-commentary'
Plug 'tpope/vim-fugitive'
Plug 'tpope/vim-git'
Plug 'tpope/vim-markdown'
Plug 'tpope/vim-rhubarb'
Plug 'tpope/vim-surround'
Plug 'tpope/vim-vinegar'
Plug 'yegappan/lsp'
plug#end()

filetype plugin indent on

##
## Global Options
##

set autoindent
set autoread
set backspace=indent,eol,start
set backup
set backupdir=~/.backup/vim
set belloff=all
set breakindent
set clipboard^=unnamed,unnamedplus
set completeopt=menuone,longest,popup
set confirm
set copyindent
set cursorline
set encoding=utf-8
set formatoptions+=j
set hidden
set history=10000
set hlsearch
set ignorecase
set incsearch
set laststatus=2
set lazyredraw
set list
set listchars=tab:>·,trail:·,nbsp:~
set modelines=0
set mouse=a
set mousemodel=popup_setpos
set nojoinspaces
set nolangremap
set nostartofline
set path-=/usr/include
set preserveindent
set ruler
set scrolloff=3
set shell=zsh
set shortmess+=C
set shortmess-=S
set showbreak=↳\ 
set showcmd
set showmatch
set sidescroll=1
set smartcase
set smarttab
set spelllang=en_us
set statusline=%<%f\ %h%m%r%{FugitiveStatusline()}%=%-14.(%l,%c%V%)\ %P
set tabpagemax=50
set tags=tags;~
set termguicolors
set title
set ttimeout
set ttimeoutlen=50
set ttyfast
set updatetime=1000
set visualbell
set wildignore+=*.o,*.pyc
set wildmenu
set wildmode=longest:full
set wildoptions=pum,tagfile

# Prefer ripgrep (rg) over external grep
if executable('rg')
  set grepprg=rg\ --vimgrep\ --no-heading\ --smart-case
  set grepformat=%f:%l:%c:%m
endif

##
## Mappings
##

g:mapleader = ','
g:localmapleader = '\'

# Remap , (Reverse last character-search command) to \ (default leader)
noremap \ ,

# Prefer display movement (when lines wrap) over linewise movement.
nnoremap j gj
nnoremap k gk

# Scroll the viewport faster
nnoremap <C-E> 4<C-E>
nnoremap <C-Y> 4<C-Y>
vnoremap <C-E> 4<C-E>
vnoremap <C-Y> 4<C-Y>

# Toggle highlighting search matches and clear/redraw screen.
nnoremap <C-L> :set hlsearch!<CR><C-L>

##
## Mappings used frequently
##

# Spell checking
nnoremap <unique> <Leader>s :set spell!<CR>

# Toggle pasting
nnoremap <unique> <Leader>p :set paste!<CR>:set paste?<CR>

# String trailing whitespace
nnoremap <unique> <Leader>stw :<C-U>call StripTrailingWhitespace()<CR>

# ALE
nmap <unique> <Leader>Ad <Plug>(ale_detail)
nmap <unique> <Leader>Af <Plug>(ale_fix)
nmap <unique> <C-j> <Plug>(ale_next_wrap)
nmap <unique> <C-k> <Plug>(ale_previous_wrap)

# Dash
nmap <unique> <silent> <Leader>D <Plug>DashSearch

# fzf.vim
nnoremap <unique> <Leader>g :FzfRg<SPACE>
nnoremap <unique> <Leader>b :FzfBuffers<CR>
nnoremap <unique> <Leader>f :FzfFiles<CR>
nnoremap <unique> <Leader>h :FzfHelptags<CR>
nnoremap <unique> <silent>K :execute 'FzfRg' expand('<cword>')<CR>

# NERDTree
nnoremap <unique> <silent> <Leader>d :execute 'NERDTreeToggle' getcwd()<CR>
nnoremap <unique> <silent> <Leader>t :NERDTreeFind<CR>

# vim-test
nnoremap <unique> <silent> <Leader>Tf :TestFile<CR>
nnoremap <unique> <silent> <Leader>Tn :TestNearest<CR>

##
## Automatic commands
##

augroup vimrc
  # Remove all vimrc autocommands
  autocmd!

  # Jump to last position in file after opening. Nice!
  autocmd BufReadPost * {
    if line("'\"") > 0 && line("'\"") <= line('$')
      exe "normal! g`\""
    endif
  }
augroup END

##
## Colors
##

syntax on

set background=light

g:PaperColor_Theme_Options = {
  'theme': {
    'default': {
      'transparent_background': 1
    }
  }
}

colorscheme PaperColor
# colorscheme dayfox

##
## Commands
##

# ctags
#command! MakeTags !ctags -R .

##
## Plugin Configuration
##

#
# fzf.vim
#
g:fzf_command_prefix = 'Fzf'

if executable('rg')
  $FZF_DEFAULT_COMMAND = "rg --files --hidden --glob '!{node_modules,.git}'"
endif

def FzfRgSuper(query: string, fullscreen: bool)
  const command_fmt = 'rg --column --line-number --no-heading --color=always --smart-case -- %s || true'
  const initial_command = printf(command_fmt, shellescape(query))
  const reload_command = printf(command_fmt, '{q}')
  const spec = {'options': ['--phony', '--query', query, '--bind', 'change:reload:' .. reload_command]}

  fzf#vim#grep(initial_command, 1, fzf#vim#with_preview(spec), fullscreen)
enddef

command! -nargs=* -bang FzfRG call FzfRgSuper(<q-args>, <bang>0)

#
# ALE
#
g:ale_completion_enabled = 0
g:ale_disable_lsp = 1
g:ale_echo_msg_format = '[%linter%] %code: %%s'
g:ale_fix_on_save = 1
g:ale_lint_on_save = 0
g:ale_sign_error = 'E>'
g:ale_sign_info = 'I>'
g:ale_sign_warning = 'W>'
g:ale_virtualtext_cursor = 'current'

#
# NERDTree
#
g:NERDTreeHijackNetrw = 1
g:NERDTreeIgnore = ['^__pycache__$', '\~$']
g:NERDTreeWinSize = 41 # default = 31

#
# netrw
#
# g:netrw_altv = 1
g:netrw_banner = 1
# g:netrw_browse_split = 4
# g:netrw_list_hide = netrw_gitignore#Hide()
# g:netrw_liststyle = 3

#
# asyncomplete.vim
#
# g:asyncomplete_log_file = expand('~/asyncomplete.log')

# imap <C-@> <Plug>(asyncomplete_force_refresh)

autocmd BufRead,BufNewFile */.github/*/*.y{,a}ml b:ale_linters = {'yaml': ['actionlint', 'prettier', 'yamllint']}

#
# yegappan/lsp
#
runtime vim_y_lsp.vim

#
# vim-lsp
#
# runtime vim_lsp.vim

#
# neural
#

g:neural = {
  'providers': [
    {
      'api_key': $MISTRAL_API_KEY,
      'url': 'https://api.mistral.ai',
      'model': 'codestral-2508'
    },
  ],
}
